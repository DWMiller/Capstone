var dmf=function(){"use strict";var a={},b=!1;return{container:null,modules:a,config:{},data:{},events:{},templates:{},classes:{},fn:{},activate:function(a){"undefined"!=typeof a.debug&&this.debug(a.debug),"undefined"!=typeof a.container?this.container=document.querySelector(a.container):this.container=document.querySelector("body"),this.startModule("system-controller"),"undefined"!=typeof a.startup&&this.startModule(a.startup)},debug:function(a){b="undefined"!==a?!!a:!b},extendConfig:function(a){this.extend(this.config,a)},createModule:function(b,c){"string"==typeof b&&"function"==typeof c?(a[b]={create:c,config:this.config[b],instance:null},this.log(1,"Module '"+b+"' Registration : SUCCESS")):this.log(2,"Module '"+b+"' Registration : FAILED : one or more arguments are of incorrect type")},getModule:function(b){var c=a[b];return!!c&&c.create(this,c.config)},startModule:function(b){var c=a[b];c&&(c.instance=this.getModule(b),c.instance.initialize&&"function"==typeof c.instance.initialize&&c.instance.initialize(this.Sandbox.create(this,c.instance.properties)),c.instance.properties.listeners&&this.registerEvents(c.instance.properties.listeners,b),this.log(1,"Start Module '"+b+"': SUCCESS"))},startModules:function(a){a.forEach(this.startModule,this)},startAllModules:function(){var b;for(b in a)a.hasOwnProperty(b)&&this.startModule(b)},stopModule:function(b){var c=a[b];return c&&c.instance?(c.instance.properties.listeners&&this.removeEvents(Object.keys(c.instance.properties.listeners),b),c.instance.destroy&&"function"==typeof c.instance.destroy&&c.instance.destroy(),c.instance=null,delete c.instance,void this.log(1,"Stop Module '"+b+"': SUCCESS")):void this.log(2,"Stop Module '"+b+"': FAILED : module does not exist or has not been started")},stopModules:function(a){a.forEach(this.stopModule,this)},stopAllModules:function(){var b;for(b in a)a.hasOwnProperty(b)&&this.stopModule(b)},registerEvents:function(a,b){this.is_obj(a)&&b||this.log(1,"Error registering events for: "+b);for(var c in a)this.events[c]||(this.events[c]={}),this.events[c][b]=a[c]},notify:function(a){"string"==typeof a&&(a={type:a,data:{}});var b=this.events[a.type];if(b){var c;for(c in b)b[c](a.data)}},removeEvents:function(a,b){a.forEach(function(a,c,d){delete dmf.events[a][b]})},log:function(a,c){if(b){this.is_arr(c)||(c=[c]);for(var d=0;d<c.length;d++)console[1===a?"log":2===a?"warn":"error"](JSON.stringify(c[d],null,4))}},is_arr:function(a){return jQuery.isArray(a)},is_obj:function(a){return jQuery.isPlainObject(a)},extend:function(a,b){jQuery.extend(!0,a,b)}}}(),CORE=dmf;dmf.dom=function(){return{find:function(a,b){var c={};return c=b?b.querySelector(a):document.querySelector(a)},listen:function(a,b,c){a&&b&&("function"==typeof b&&(c=b,b="click"),a.addEventListener(b,c))},ignore:function(a,b,c){a&&b&&("function"==typeof b&&(c=b,b="click"),a.removeEventListener(b,c))},addClass:function(a,b){jQuery(a).addClass(b)},removeClass:function(a,b){jQuery(a).removeClass(b)},toggleClass:function(a,b){jQuery(a).toggleClass(b)},emptyNode:function(a){if(a instanceof jQuery)a.html("");else for(;a.firstChild;)a.removeChild(a.firstChild)},append:function(a,b){a instanceof jQuery||(a=$(a)),b instanceof jQuery||(b=$(b)),a.append(b)}}}(),dmf.Sandbox={create:function(a,b){var c=(b.id||null,b.selector||null),d=document.getElementById(c)||a.container;return{self:function(){return a.log(2,"Sandbox:self() deprecated, sandbox being removed"),d},find:function(b){return a.log(2,"Sandbox:find() deprecated, sandbox being removed"),a.dom.find(b,d)},hide:function(b){a.log(2,"Sandbox:hide() deprecated, sandbox being removed"),"undefined"==typeof b&&(b=d),a.dom.removeClass(b,"visible"),a.dom.addClass(b,"hidden")},show:function(b){a.log(2,"Sandbox:show() deprecated, sandbox being removed"),"undefined"==typeof b&&(b=d),a.dom.addClass(b,"visible"),a.dom.removeClass(b,"hidden")}}}},dmf.extendConfig({"system-server":{endpoint:"http://127.0.0.1:8080/",timeout:7e3},"system-localize":{default_language:"en",path:"assets/localization/",ext:".lang.json"}}),dmf.createModule("system-controller",function(a){"use strict";function b(b){a.startModules(["system-server","system-data","system-localize"])}function c(){a.stopModules(["system-server","system-data","system-localize"])}var d={id:"system-controller",listeners:{}};return{properties:d,initialize:b,destroy:c}}),dmf.createModule("system-localize",function(a,b){"use strict";function c(a){l=b.default_language,f()}function d(){k={}}function e(a){l=a.language,f()}function f(){n[l]?g():$.getJSON(b.path+l+b.ext).done(function(a){n[l]=a,g()})}function g(){console.log("Language changed to "+l),a.extend(a.data,{language:n[l]}),h()}function h(){for(var a=document.querySelectorAll(".localize"),b=0;b<a.length;b++)i(a[b])}function i(a){var b=a.getAttribute("data-localize"),c=j(b);if(!c)return!1;switch(a.tagName){case"INPUT":a.value=c;break;default:a.innerHTML=c}}function j(b){return!!a.data.language[b]&&a.data.language[b]}var k,l,m={id:"system-localize",listeners:{"language-change":e}},n={};return{properties:m,initialize:c,destroy:d}}),dmf.createModule("system-server",function(a,b){"use strict";function c(){}function d(c){a.log(1,["REQUEST",c]),g&&(c.session=g);var d={url:b.endpoint,timeout:b.timeout,data:JSON.stringify(c),type:"POST",dataType:"json",crossDomain:!0};return $.ajax(d).done(function(b){a.log(1,["RESPONSE",b]);for(var c in b)a.notify({type:c,data:b[c]});a.notify({type:"server-response",data:b})}).fail(function(b){a.notify({type:"server-fail",data:b})}).always(function(a){})}function e(a){g=a}function f(){g=null}var g,h={id:"system-server",listeners:{"server-request":c,"server-post":d,"session-set":e,"session-clear":f}};return{properties:h}}),dmf.extendConfig({animator:{dragCheckThreshold:100,imageMapping:{"system-terran":"system-terran","system-desert":"system-desert","system-gasGiant":"system-gasGiant","system-ice":"system-ice","system-molten":"system-molten","system-volcanic":"system-volcanic","system-asteroid":"system-asteroid","system-wormhole":"system-wormhole",fleet:"fleet",beaker:"beaker",anchor:"anchor",mine:"mine",explosion:"explosion","system-blueGiant":"system-blueStar","system-blueHyperGiant":"system-blueStar","system-blueStar":"system-blueStar","system-whiteDwarf":"system-whiteStar","system-yellowStar":"system-yellowStar","system-redDwarf":"system-redStar","system-redGiant":"system-redStar","sector-blueGiant":"sector-blueStar","sector-blueHyperGiant":"sector-blueStar","sector-blueStar":"sector-blueStar","sector-whiteDwarf":"sector-whiteStar","sector-yellowStar":"sector-yellowStar","sector-redDwarf":"sector-redStar","sector-redGiant":"sector-redStar"},imagePath:"assets/images/map/",drawScaleFactor:{sector:15,system:20},colours:{neutralWhite:{hex:"#EAEAEA",r:234,g:234,b:234},ownedGreen:{hex:"#0A9210",r:10,g:146,b:16},enemyRed:{hex:"#E0140A",r:224,g:20,b:10}},text:{font:"Verdana",fontSize:16,lineSpacing:4}}}),dmf.extendConfig({lobby:{UPDATE_INTERVAL:5e3},game:{UPDATE_INTERVAL:5e3,defaultData:{scale:"sector",id:1}}}),dmf.extendConfig({engine:{SIM_INTERVAL:17}}),dmf.extendConfig({language:{default_language:"en",path:"js/game/localization/",ext:".lang.json"}}),dmf.extendConfig({"system-server":{endpoint:"../server/main.php"}}),dmf.templates.location=function(a){var b=(1*a.mines+1*a.shipyards+1*a.labs,a.owner_id===CORE.data.user.id),c=$("<div>");b&&c.addClass("owned");var d=$("<p>");return $("<span>",{class:"label"}).text("Type:").appendTo(d),$("<span>",{class:"value"}).text(CORE.data.language.map[a.type]).appendTo(d),c.append(d),d=$("<p>"),$("<span>",{class:"label"}).text("Resources:").appendTo(d),$("<span>",{class:"value"}).text(a.resources).appendTo(d),c.append(d),d=$("<p>"),$("<span>",{class:"label"}).text("Size:").appendTo(d),$("<span>",{class:"value"}).text(a.size).appendTo(d),c.append(d),$("<hr>").appendTo(c),$("<h3>").text("Planet Infrastructure").appendTo(c),d=$("<p>",{class:"upgrade-btn structure-mine","data-structure":"mine",title:CORE.data.language.structure.mines}),$("<span>",{class:"level"}).text(a.mines).appendTo(d),b&&a.resources>0&&$("<span>",{class:"cost"}).text("Cost: "+CORE.Helpers.commafy(a["upgrade-cost-mine"])).appendTo(d),c.append(d),d=$("<p>",{class:"upgrade-btn structure-shipyard","data-structure":"shipyard",title:CORE.data.language.structure.shipyards}),$("<span>",{class:"level"}).text(a.shipyards).appendTo(d),b&&a.resources>0&&$("<span>",{class:"cost"}).text("Cost: "+CORE.Helpers.commafy(a["upgrade-cost-shipyard"])).appendTo(d),c.append(d),d=$("<p>",{class:"upgrade-btn structure-lab","data-structure":"lab",title:CORE.data.language.structure.labs}),$("<span>",{class:"level"}).text(a.labs).appendTo(d),b&&a.resources>0&&$("<span>",{class:"cost"}).text("Cost: "+CORE.Helpers.commafy(a["upgrade-cost-lab"])).appendTo(d),c.append(d),b&&(d=$("<p>"),$("<input>",{type:"text",value:a.name}).appendTo(d),$("<button>",{class:"location-rename"}).text("Rename").appendTo(d),c.append(d)),c},dmf.templates.system=function(a){var b=$("<div>"),c=$("<p>");return $("<span>",{class:"label"}).text("Type:").appendTo(c),$("<span>",{class:"value"}).text(CORE.data.language.map[a.type]).appendTo(c),b.append(c),c=$("<p>"),$("<span>",{class:"label"}).text("Size:").appendTo(c),$("<span>",{class:"value"}).text(a.size).appendTo(c),b.append(c),$("<hr>").appendTo(b),b},dmf.templates.userDetails=function(a){var b=$("<div>"),c=$("<p>").addClass("input-group");return $("<span>",{class:"label"}).text("Currency").appendTo(c),$("<span>",{class:"value"}).text(dmf.Helpers.commafy(a.resources)).appendTo(c),$("<span>",{class:"label"}).text("Research Points").appendTo(c),$("<span>",{class:"value"}).text(dmf.Helpers.commafy(a.knowledge)).appendTo(c),b.append(c),c=$("<p>",{class:"upgrade-btn research-start research-armour","data-research":"armour",title:"Armour research - reduces ship losses in combat "}),$("<span>",{class:"level"}).text(a.tech_armour).appendTo(c),$("<span>",{class:"cost"}).text("Cost: "+dmf.Helpers.commafy(a.tech_armour_cost)).appendTo(c),b.append(c),c=$("<p>",{class:"upgrade-btn research-start research-propulsion","data-research":"propulsion",title:"Propulsion research - increases fleet movement speed "}),$("<span>",{class:"level"}).text(a.tech_propulsion).appendTo(c),$("<span>",{class:"cost"}).text("Cost: "+dmf.Helpers.commafy(a.tech_propulsion_cost)).appendTo(c),b.append(c),c=$("<p>",{class:"upgrade-btn research-start research-weapons","data-research":"weapons",title:"Weapons research - kill more ships in combat "}),$("<span>",{class:"level"}).text(a.tech_weapons).appendTo(c),$("<span>",{class:"cost"}).text("Cost: "+dmf.Helpers.commafy(a.tech_weapons_cost)).appendTo(c),b.append(c),b},CORE.createModule("controller",function(a){"use strict";function b(a){d()}function c(){a.stopAllModules()}function d(){console.log("STATE: Startup"),a.startModules(["login","register"])}function e(){console.log("STATE: Authenticated"),a.startModules(["logout","lobby"]),a.stopModules(["login","register"])}function f(){console.log("STATE: Playing Game"),a.stopModule("lobby"),a.startModules(["game","commands","fleets","animator","widgets","details","user"])}function g(){console.log("STATE: Shutting Down"),a.stopModules(["lobby","login","logout","register","game","commands","fleets","animator","widgets","details","admin","user","admin"])}function h(){g(),d()}var i={id:"controller",listeners:{"state-startup":d,"state-authenticated":e,"state-play":f,"state-shutdown":g,"state-restart":h}};return{properties:i,initialize:b,destroy:c}}),dmf.Helpers=function(){"use strict";return{commafy:function(a){return a?a.toString().split(/(?=(?:\d{3})+(?:\.|$))/g).join(","):"0"}}}(),dmf.createModule("admin",function(a){"use strict";function b(a){l=a,m={game_end:document.getElementById("admin-game_end"),game_start:document.getElementById("admin-game_start"),stop:document.getElementById("admin-module-stop")},l.show(),d(),n=setInterval(i,15e3),p=setInterval(j,3e3),o=setInterval(k,250)}function c(a){a&&a.preventDefault(),l.hide(),e(),l=null,m={},clearInterval(n),clearInterval(p),clearInterval(o)}function d(){a.dom.listen(m.game_end,"click",g),a.dom.listen(m.game_start,"click",h),a.dom.listen(m.stop,"click",f)}function e(){a.dom.ignore(m.game_end,"click",g),a.dom.ignore(m.game_start,"click",h),a.dom.ignore(m.stop,"click",f)}function f(b){b.preventDefault&&b.preventDefault(),a.stopModule(q.id)}function g(b){b.preventDefault&&b.preventDefault(),a.notify({type:"server-post",data:{api:{admin:{end_game:{placeholder:!0}}}}})}function h(b){b.preventDefault&&b.preventDefault(),a.notify({type:"server-post",data:{api:{admin:{new_game:{placeholder:!0}}}}})}function i(){3==a.data.user.status&&a.notify({type:"server-post",data:{api:{cron:{executeTurn:{placeholder:!0}}}}})}function j(){3==a.data.user.status&&a.notify({type:"server-post",data:{api:{cron:{executeCombatTurn:{placeholder:!0}}}}})}function k(){3==a.data.user.status&&a.notify({type:"server-post",data:{api:{cron:{executeMaintainence:{placeholder:!0}}}}})}var l,m,n,o,p,q={id:"admin",selector:"module-admin",listeners:{}};return{properties:q,initialize:b,destroy:c}}),dmf.createModule("animator",function(a,b){"use strict";function c(a){H=a,O.mapWrapper=$("#game-map"),O.user=$("#module-user"),K=O.mapWrapper.width(),L=O.mapWrapper.height()-O.user.height(),O.back=H.find("#map-back"),O.stage=new Kinetic.Stage({container:"game-map",width:K,height:L}),J={fontSize:b.text.fontSize,fontFamily:b.text.font,fontVariant:"small-caps",fill:b.colours.neutralWhite.hex},e(),s(),I=requestAnimationFrame(G),H.show()}function d(){cancelAnimationFrame(I),H.hide(),f(),H=null,O={}}function e(){O.layers.map.on("click touchstart",k),O.layers.map.on("mouseover touchstart",i),O.layers.map.on("mouseout touchend",j),O.layers.fleets.on("dragstart",l),O.layers.fleets.on("dragend",n),O.layers.fleets.on("dragmove",m)}function f(){O.layers.map.off("click touchstart",k),O.layers.map.off("mouseover touchstart",i),O.layers.map.off("mouseout touchend",j),O.layers.fleets.off("dragstart",l),O.layers.fleets.off("dragend",n)}function g(b){a.data.map.system.forEach(function(a,c,d){a.id===b.id&&(d[c]=b)}),b.scale="location",a.notify({type:"map-focus",data:b}),w()}function h(){U.action||w()}function i(b){a.dom.addClass(H.self(),"hover");var c=b;"undefined"!=typeof b.target&&(c=b.target.data),a.notify({type:"map-focus",data:c})}function j(){a.dom.removeClass(H.self(),"hover")}function k(b){var c=b.target.data;a.notify({type:"map-click",data:c})}function l(a){M=T,U.action=!0,R=a.target}function m(a){if(!(M>T-b.dragCheckThreshold)){M=T;var c=a.target;o(c)}}function n(b){U.action=!1,S&&(a.notify({type:"fleet-move",data:{fleet:R.data,target:S.data}}),S.data.fleetMove=!1,S=!1,R=!1),a.notify("details-clear")}function o(b){var c=b.data,d=!1,e=!1;S&&q(b,S)||(O.layers.map.getChildren().each(function(a){a.kFocus&&a.kFocus.remove();var f=a.data;if(!("location"===f.scale&&f.id===c.location_id||"system"===f.scale&&f.wormhole_id===c.location_id))return q(a,b)?(p(a),S&&S.data===f||(e=!0),S=a,void(d=!0)):void 0}),d?(S.data.fleetMove=!0,e&&a.notify({type:"details-show",data:S.data})):(S=null,a.notify("details-hide")))}function p(a){a.kFocus=new Kinetic.Circle({x:a.attrs.x+a.getWidth()/2,y:a.attrs.y+a.getHeight()/2,radius:a.getWidth(),opacity:.4,stroke:"blue",strokeWidth:3}),O.layers.overlay.add(a.kFocus)}function q(a,b){var c,d,e,f,g,h,i,j;return c=a.getX(),d=a.getY(),e=a.getWidth(),f=a.getHeight(),g=b.getX(),h=b.getY(),i=b.getWidth(),j=b.getHeight(),i+=g,e+=c,!(g>e||c>i)&&(j+=h,f+=d,!(h>f||d>j))}function r(a,b){return{x:a/1e3*(.85*K)+.07*K,y:b/1e3*(.85*L)+.07*L}}function s(){t("system-terran","system/terran.png"),t("system-desert","system/desert.png"),t("system-gasGiant","system/gasGiant.png"),t("system-ice","system/ice.png"),t("system-molten","system/molten.png"),t("system-volcanic","system/volcanic.png"),t("system-asteroid","system/asteroid.png"),t("system-blueStar","system/blueStar.png"),t("system-redStar","system/redStar.png"),t("system-yellowStar","system/yellowStar.png"),t("system-whiteStar","system/whiteStar.png"),t("system-wormhole","system/wormhole.png"),t("sector-blueStar","sector/blueStar.png"),t("sector-redStar","sector/redStar.png"),t("sector-yellowStar","sector/yellowStar.png"),t("sector-whiteStar","sector/whiteStar.png"),t("fleet","fleet.png"),t("explosion","system/explosion.jpg"),t("beaker","beaker.png"),t("anchor","anchor.png"),t("mine","mine.png"),u()}function t(a,c){P[a]=new Image,P[a].src=b.imagePath+c}function u(){var a,c;a=84,c=84,P.sprites.wormhole={image:P[b.imageMapping["system-wormhole"]],animation:"idle",animations:{idle:[0,0,a,c,a,0,a,c,2*a,0,a,c,3*a,0,a,c,0,a,a,c,a,a,a,c,2*a,a,a,c,3*a,a,a,c,0,2*a,a,c,a,2*a,a,c,2*a,2*a,a,c,3*a,2*a,a,c,0,3*a,a,c,a,3*a,a,c,2*a,3*a,a,c]},frameRate:20,frameIndex:0}}function v(){var a=$(H.self()).height()-O.user.height();L==a&&K==O.mapWrapper.width()||(K=O.mapWrapper.width(),L=a,O.stage.setWidth(K),O.stage.setHeight(L),console.log("resizing"))}function w(){v(),O.layers.map.destroyChildren(),O.layers.overlay.destroyChildren(),j(),a.data.map.sector&&"sector"===a.data.map.scale&&a.data.map.sector.forEach(B),a.data.map.system&&"system"===a.data.map.scale&&a.data.map.system.forEach(C),O.stage.add(O.layers.map),O.stage.add(O.layers.overlay),x()}function x(){U.action||(y(),O.layers.fleets.destroyChildren(),a.data.map.fleets&&a.data.map.fleets.forEach(A),O.stage.add(O.layers.fleets))}function y(){var a=O.layers.fleets.getChildren().toArray();a.length<1||a.forEach(function(a){a.data.overlay&&(a.data.overlay.forEach(function(a){a.remove(),a=null}),a.data.overlay=null)})}function z(){O.layers.fleets.getChildren().each(function(b){var c=b.data;if(!c.arrived&&c.destination_id){var d,e,f,g;"system"===a.data.map.scale?(d=c.position_x,e=c.position_y,f=c.destination_x,g=c.destination_y):"sector"===a.data.map.scale&&(d=c.location_system_x,e=c.location_system_y,f=c.destination_system_x,g=c.destination_system_y),c.overlay.forEach(function(a){a.remove(),a=null}),c.overlay=null;var h=T-1e3*c.departure_time,i=1e3*c.arrival_time-1e3*c.departure_time+2e3;if(h>i)return d=f,e=g,c.arrived=!0,void a.notify("map-data-outdated");var j=h/i;d=1*d+1*(f-d)*j,e=1*e+1*(g-e)*j;var k=r(d,e);b.setX(k.x),b.setY(k.y),c.overlay=F(c,b.attrs)}})}function A(c){if(!c.destination_id||"system"!==a.data.map.scale||c.destination_system===a.data.map.id){c.scale="fleet";var d,e,f,g,h=c.owner_id===a.data.user.id,i={x:0,y:0};c.destination_id||("system"===a.data.map.scale?(d=c.position_x,e=c.position_y,f=c.destination_x,g=c.destination_y):"sector"===a.data.map.scale&&(d=c.location_system_x,e=c.location_system_y,f=c.destination_system_x,g=c.destination_system_y),i=r(d,e),h?(i.x+=10,i.y-=15):(i.x-=50,i.y-=15));var j=2*Math.log(c.size+5),k=45+j,l=30+j,m=new Kinetic.Image({x:i.x,y:i.y,image:P[b.imageMapping.fleet],draggable:h&&!c.destination_id,width:k,height:l});m.data=c,O.layers.fleets.add(m),m.cache(),m.filters([Kinetic.Filters.RGB]),h?(m.red(b.colours.ownedGreen.r),m.green(b.colours.ownedGreen.g),m.blue(b.colours.ownedGreen.b)):(m.red(b.colours.enemyRed.r),m.green(b.colours.enemyRed.g),m.blue(b.colours.enemyRed.b)),c.overlay=F(c,m.attrs)}}function B(c){c.scale="system",c.src="sector-"+c.type;var d=r(c.position_x,c.position_y),e=Math.sqrt(c.size)*b.drawScaleFactor[a.data.map.scale],f=Math.sqrt(c.size)*b.drawScaleFactor[a.data.map.scale],g=new Kinetic.Image({x:d.x-e/2,y:d.y-f/2,image:P[b.imageMapping[c.src]],width:e,height:f});g.data=c,O.layers.map.add(g),D(c,g.attrs)}function C(c){var d=r(c.position_x,c.position_y);c.scale="location";var e;"wormhole"===c.type?(e=new Kinetic.Sprite(P.sprites.wormhole),e.stop(),e.start()):(c.src="system-"+c.type,e=new Kinetic.Image({image:P[b.imageMapping[c.src]],width:Math.sqrt(c.size)*b.drawScaleFactor[a.data.map.scale],height:Math.sqrt(c.size)*b.drawScaleFactor[a.data.map.scale]})),e.setHeight(Math.sqrt(c.size)*b.drawScaleFactor[a.data.map.scale]),e.setWidth(Math.sqrt(c.size)*b.drawScaleFactor[a.data.map.scale]),e.setX(d.x-e.getWidth()/2),e.setY(d.y-e.getHeight()/2),e.data=c,O.layers.map.add(e),E(c,e)}function D(c,d){if(c.ownedShipTotal){var e=$.extend({},J,{x:d.x-d.width/2,y:d.y-2*b.text.lineSpacing,text:a.Helpers.commafy(c.ownedShipTotal),fill:b.colours.ownedGreen.hex});O.layers.overlay.add(new Kinetic.Text(e))}if(c.enemyShipTotal){var f=$.extend({},J,{x:d.x+d.width,y:d.y-2*b.text.lineSpacing,text:a.Helpers.commafy(c.enemyShipTotal),fill:b.colours.enemyRed.hex});O.layers.overlay.add(new Kinetic.Text(f))}var g,h,i,j,k=$.extend({},J,{x:d.x,y:d.y+d.height+b.text.lineSpacing,text:c.name,fill:b.colours.neutralWhite.hex}),l=c.ownedLocationTotal+c.enemyLocationTotal+c.neutralLocationTotal-2,m=c.ownedLocationTotal/l,n=(c.neutralLocationTotal-2)/l,o=c.enemyLocationTotal/l;g=d.x,i=d.y+d.height+b.text.fontSize+2*b.text.lineSpacing,h=d.x+20*l,j=d.y+d.height+b.text.fontSize+2*b.text.lineSpacing;var p=O.layers.overlay.getContext(),q=p.createLinearGradient(g,i,h,j),r=0;m>0&&(q.addColorStop(r,b.colours.ownedGreen.hex),r+=m),n>0&&(r+=n/2,q.addColorStop(r,b.colours.neutralWhite.hex)),o>0&&q.addColorStop(1,b.colours.enemyRed.hex);var s=new Kinetic.Line({points:[g,i,h,j],stroke:q,strokeWidth:7});O.layers.overlay.add(s),O.layers.overlay.add(new Kinetic.Text(k))}function E(c,d){if("wormhole"!==c.type){var e;e=c.owner_id?c.owner_id===a.data.user.id?b.colours.ownedGreen.hex:b.colours.enemyRed.hex:b.colours.neutralWhite.hex;var f=$.extend({},J,{x:d.getX(),y:d.getY()+d.getHeight()+b.text.lineSpacing,text:c.name,fill:e});if(O.layers.overlay.add(new Kinetic.Text(f)),"star"!==c.category){var g=d.getY()+d.getHeight()/3-2*(b.text.fontSize+b.text.lineSpacing),h=20,i=d.getX()-30,j=5,k=$.extend({},Q,{x:i,y:g,image:P[b.imageMapping.mine]});i+=h+j;var l=$.extend({},J,{x:i,y:g,text:c.mines,fill:e});i+=h+j;var m=$.extend({},Q,{x:i,y:g,image:P[b.imageMapping.anchor]});i+=h+j;var n=$.extend({},J,{x:i,y:g,text:c.shipyards,fill:e});i+=h+j;var o=$.extend({},Q,{x:i,y:g,image:P[b.imageMapping.beaker]});i+=h+j;var p=$.extend({},J,{x:i,y:g,text:c.labs,fill:e});O.layers.overlay.add(new Kinetic.Image(k)),O.layers.overlay.add(new Kinetic.Text(l)),O.layers.overlay.add(new Kinetic.Image(m)),O.layers.overlay.add(new Kinetic.Text(n)),O.layers.overlay.add(new Kinetic.Image(o)),O.layers.overlay.add(new Kinetic.Text(p))}}}function F(c,d){var e=[],f=c.owner_id===a.data.user.id,g=$.extend({},J,{x:f?d.x+d.width:d.x-30,y:d.y-5,text:a.Helpers.commafy(c.size),fill:f?b.colours.ownedGreen.hex:b.colours.enemyRed.hex});if(c.destination_id){var h,i,j,k;"system"===a.data.map.scale?(j=c.destination_x,k=c.destination_y):"sector"===a.data.map.scale&&(j=c.destination_system_x,k=c.destination_system_y);var l=r(j,k);h=d.x+d.width/2,i=d.y+d.height/2;var m=new Kinetic.Line({points:[h,i,l.x,l.y],stroke:f?b.colours.ownedGreen.hex:b.colours.enemyRed.hex,lineJoin:"round",strokeWidth:2,dash:[6,4]});O.layers.overlay.add(m),e.push(m)}return g=new Kinetic.Text(g),e.push(g),O.layers.overlay.add(g),e}function G(a){T=(new Date).getTime(),z(),I=requestAnimationFrame(G),O.stage.drawScene()}var H,I,J,K,L,M,N={id:"animator",selector:"module-game",listeners:{"location-update":g,"data-updated":h,"inject-fleet":A,"fleet-data-updated":x}},O={stage:null,layers:{map:new Kinetic.Layer,overlay:new Kinetic.Layer,fleets:new Kinetic.Layer}},P={sprites:{}},Q={width:20,height:20},R=null,S=null,T=(new Date).getTime(),U={action:!1};return{state:U,properties:N,initialize:c,destroy:d}}),dmf.createModule("commands",function(a,b){"use strict";function c(a){j=a;for(var b in m)l[b]=$("#command-"+b);e(),j.show()}function d(){j.hide(),f(),l={},j=null}function e(){$(j.self()).on("click",".command-btn",h),$(document).on("keydown",g),$(document).on("keyup",g)}function f(){$(j.self()).off("click",".command-btn",h),$(document).off("keydown",g),$(document).off("keyup",g)}function g(a){var b=a.type;n.hasOwnProperty(a.which)&&i(n[a.which],"keyup"!==b)}function h(a){var b=$(a.currentTarget),c=b.data("command"),d=b.hasClass("active");i(c,!d)}function i(a,b){b?(l[a].addClass("active"),m[a]=!0):(l[a].removeClass("active"),m[a]=!1)}var j,k={id:"commands",selector:"module-commandBar",listeners:{}},l={},m={groupMove:!1,fleetSplit:!1},n={71:"groupMove",83:"fleetSplit"};return{properties:k,initialize:c,destroy:d,options:m,toggleCommand:i}}),dmf.createModule("details",function(a){"use strict";function b(a){l=a,m={header:l.find(".module-header"),contents:l.find(".module-contents")},d(),l.show()}function c(){l.hide(),e(),l=null,m={}}function d(){$(m.contents).on("click",".upgrade-btn",f),$(m.contents).on("click",".location-rename",g)}function e(){$(m.contents).off("click",".upgrade-btn",f),$(m.contents).off("click",".location-rename",g)}function f(b){var c=$(b.target),d=c.attr("data-structure");a.notify({type:"server-post",data:{api:{empire:{upgrade:{location:n.id,type:d}}}}})}function g(b){var c=$(b.currentTarget),d=c.prev("input").val();a.notify({type:"server-post",data:{api:{empire:{rename:{location:n.id,name:d}}}}})}function h(a){$.extend(n,a),i(n)}function i(b){if("undefined"!=typeof b){var c=n;j(),n=b,$(m.header).text(b.name);var d=a.templates[b.scale](b);$(m.contents).html(d),b.fleetMove&&$(m.contents).append('<h3 class="blink_me">Release fleet to issue a movement command to this location</h3>'),c&&c.id===b.id?$(m.contents).show():$(m.contents).fadeIn(600)}}function j(){$(m.contents).hide()}function k(){n=null,m.contents.innerHTML="",j()}var l,m,n,o={id:"details",selector:"module-details",listeners:{"details-show":i,"location-update":h,"map-focus":i,"details-hide":j,"details-clear":k}};return{properties:o,initialize:b,destroy:c}}),dmf.createModule("lobby",function(a,b){"use strict";function c(a){o=a,p={"queue-join":document.getElementById("queue-join"),"queue-leave":document.getElementById("queue-leave"),join:document.getElementById("queue-join-submit"),leave:document.getElementById("queue-leave-submit")},e(),o.show(),i(),q=setInterval(i,b.UPDATE_INTERVAL)}function d(){clearInterval(q),o.hide(),f(),o=null,p={}}function e(){a.dom.listen(p.join,"click",g),a.dom.listen(p.leave,"click",h)}function f(){a.dom.ignore(p.join,"click",g),a.dom.ignore(p.leave,"click",h)}function g(){event.preventDefault&&event.preventDefault(),a.notify({type:"server-post",data:{api:{game:{join_queue:{placeholder:!0}}}}})}function h(){event.preventDefault&&event.preventDefault(),a.notify({type:"server-post",data:{api:{game:{leave_queue:{placeholder:!0}}}}})}function i(){a.notify({type:"server-post",data:{api:{game:{update:{placeholder:!0}}}}})}function j(a){CORE.data.user.status=a["user-status"],k()}function k(){switch(parseInt(CORE.data.user.status)){case 0:break;case 1:l();break;case 2:m();break;case 3:n();break;case 4:}}function l(){o.hide(p["queue-leave"]),o.show(p["queue-join"])}function m(){o.hide(p["queue-join"]),o.show(p["queue-leave"])}function n(){o.hide(p["queue-join"]),o.hide(p["queue-leave"]),a.notify("state-play")}var o,p,q,r={id:"lobby",selector:"module-lobby",listeners:{"queue-update":j}};return{properties:r,initialize:c,destroy:d}}),dmf.createModule("login",function(a){"use strict";function b(a){j=a,k={email:document.getElementById("form-auth-email"),password:document.getElementById("form-auth-password"),login:document.getElementById("form-auth-login"),password_mask:document.getElementById("form-auth-password_mask"),msg:document.getElementById("auth-msg")},i(),j.show(),d()}function c(){j.hide(),e(),j=null,k={}}function d(){a.dom.listen(k.login,"click",f),a.dom.listen(k.password_mask,"click",i)}function e(){a.dom.ignore(k.login,"click",f),a.dom.ignore(k.password_mask,"click",i)}function f(b){b.preventDefault&&b.preventDefault(),a.notify({type:"server-post",data:{api:{login:{login:{email:k.email.value,password:k.password.value}}}}})}function g(b){a.data.user=b.user,a.data["user-locations"]=b.locations,a.notify({type:"session-set",data:b.user.session}),a.notify("state-authenticated"),"1"===a.data.user.is_admin&&a.startModule("admin")}function h(a){var b="";a.forEach(function(a){b+="<h2>"+a.title+"</h2>",b+="<p>"+a.msg+"</p>"}),k.msg.innerHTML=b}function i(){k.password_mask.checked?$(k.password).attr("type","text"):$(k.password).attr("type","password")}var j,k,l={id:"login",selector:"page-auth",listeners:{"login-success":g,"login-failure":h,"register-success":f}};return{properties:l,initialize:b,destroy:c}}),dmf.createModule("logout",function(a){"use strict";function b(a){g=a,h={logout:document.getElementById("form-logout-logout")},d(),g.show()}function c(){g.hide(),e(),g=null,h={}}function d(){a.dom.listen(h.logout,"click",f)}function e(){a.dom.ignore(h.logout,"click",f)}function f(b){b.preventDefault(),a.notify({type:"server-post",data:{api:{login:{logout:{placeholder:!0}}}}}),a.notify("session-clear"),a.notify("state-restart")}var g,h,i={id:"logout",selector:"page-logout",listeners:{}};return{properties:i,initialize:b,destroy:c}}),dmf.createModule("register",function(a){"use strict";function b(a){h=a,i={email:document.getElementById("form-auth-email"),password:document.getElementById("form-auth-password"),register:document.getElementById("form-auth-register"),msg:document.getElementById("auth-msg")},d(),h.show()}function c(){h.hide(),e(),h=null,i={}}function d(){a.dom.listen(i.register,"click",f)}function e(){a.dom.ignore(i.register,"click",f)}function f(b){b.preventDefault&&b.preventDefault(),a.notify({type:"server-post",data:{api:{register:{register:{email:i.email.value,password:i.password.value}}}}})}function g(a){var b="";a.forEach(function(a){b+="<h2>"+a.title+"</h2>",b+="<p>"+a.msg+"</p>"}),i.msg.innerHTML=b}var h,i,j={id:"register",selector:"page-auth",listeners:{"register-failure":g}};return{properties:j,initialize:b,destroy:c}}),dmf.createModule("user",function(a){"use strict";function b(b){i=b,d(),i.show(),a.data.user&&h()}function c(){i.hide(),e(),i=null}function d(){$(i.self()).on("click",".research-start",f)}function e(){$(i.self()).off("click",".research-start",f)}function f(b){var c=$(b.currentTarget),d=c.data("research");a.notify({type:"server-post",data:{api:{empire:{research:{type:d}}}}})}function g(b){a.data.user=b,h()}function h(){$(i.self()).html(a.templates.userDetails(a.data.user).html())}var i,j={id:"user",selector:"module-user",listeners:{"user-update":g}};return{properties:j,initialize:b,destroy:c}}),dmf.createModule("widgets",function(a){"use strict";function b(a){i=a,k.fleetSplitterContainer=$("#widget-fleetSplitter"),k.fleetSplitter=k.fleetSplitterContainer.find(".slider"),k.fleetSplitConfirm=$("#widget-fleetSplitter .widget-button"),k.fleetSplitterLabel=$("#widget-fleetSplitter .widget-label"),d()}function c(){e(),i=null,k={}}function d(){k.fleetSplitConfirm.on("click",h),k.fleetSplitterContainer.on("input",".slider",g)}function e(){k.fleetSplitConfirm.off("click",h),k.fleetSplitterContainer.off("input",".slider",g)}function f(a){i.show(k.fleetSplitterContainer[0]),k.fleetSplitter.prop({min:0,max:1*a.fleet.size,value:Math.floor(a.fleet.size/2)}),g(),l.fleetSplitter=a}function g(a){var b;b="undefined"!=typeof a?a.currentTarget.value:k.fleetSplitter.val(),k.fleetSplitterLabel.html(b+" Ships Selected")}function h(){l.fleetSplitter.split=!0,l.fleetSplitter.splitSize=k.fleetSplitter.val(),a.modules.commands.instance.toggleCommand("fleetSplit",!1),a.notify({type:"fleet-move",data:l.fleetSplitter}),i.hide(k.fleetSplitterContainer[0])}var i,j={id:"widgets",selector:"module-game",listeners:{"show-widget-fleetSplitter":f}},k={},l={fleetSplitter:null};return{properties:j,initialize:b,destroy:c}}),dmf.createModule("fleets",function(a,b){"use strict";function c(b){if(a.modules.animator.instance.state.action=!1,b.splitSize&&b.splitSize<1)return!1;var c=b.fleet,d=b.target,e=d.id;"system"===d.scale&&(e=d.wormhole_id);var f=[c.id];if(a.modules.commands.instance.options.groupMove&&(f=[],a.data.map.fleets.forEach(function(b){b.owner_id===a.data.user.id&&f.push(b.id)}),a.modules.commands.instance.toggleCommand("groupMove",!1)),a.modules.commands.instance.options.fleetSplit&&c.size>1)return a.modules.animator.instance.state.action=!0,a.notify({type:"show-widget-fleetSplitter",
data:b}),void a.modules.commands.instance.toggleCommand("fleetSplit",!1);var g={fleet:f,target:e};"undefined"!=typeof b.split&&(g.split=b.split,g.splitSize=b.splitSize),a.notify({type:"server-post",data:{api:{fleets:{move:g}}}})}function d(b){b.forEach(e),a.notify("fleet-data-updated")}function e(b){var c=!1;a.data.map.fleets.forEach(function(d,e){b.id===d.id&&(a.data.map.fleets[e]=b,c=!0)}),c||(a.data.map.fleets.push(b),a.notify({type:"inject-fleet",data:b}))}var f={id:"fleets",listeners:{"fleet-update":d,"fleet-move":c}};return{properties:f}}),dmf.createModule("game",function(a,b){"use strict";function c(c){q=c,e(),j(),a.data.map={scale:b.defaultData.scale,id:b.defaultData.id},h(),q.show()}function d(){q.hide(),f(),k(),q=null}function e(){}function f(){}function g(b){return"system"===a.data.map.scale?void("wormhole"===b.type&&o()):void n(b)}function h(){var b=a.data.map,c={api:{map:{}}};c.api.map[b.scale]={id:b.id},a.notify({type:"server-post",data:c})}function i(b){switch(b.fleets?a.data.map.fleets=b.fleets:a.data.map.fleets=!1,a.data.map.scale){case"sector":a.data.map.sector=b.systems;break;case"system":a.data.map.system=b.locations}var c={};a.data.map.sector&&a.data.map.sector.forEach(function(a,b){a.ownedShipTotal=0,a.enemyShipTotal=0,a.ownedLocationTotal=0,a.enemyLocationTotal=0,a.neutralLocationTotal=0,c[a.id]=a}),b.systemLocations&&b.systemLocations.forEach(function(b){b.owner_id===a.data.user.id?c[b.location_system].ownedLocationTotal+=1*b.owned_planets:null===b.owner_id?c[b.location_system].neutralLocationTotal+=1*b.owned_planets:c[b.location_system].enemyLocationTotal+=1*b.owned_planets}),b.systemFleets&&b.systemFleets.forEach(function(b){b.owner_id===a.data.user.id?c[b.location_system].ownedShipTotal+=1*b.size:c[b.location_system].enemyShipTotal+=1*b.size}),a.notify("data-updated")}function j(){r=setInterval(h,b.UPDATE_INTERVAL)}function k(){clearInterval(r)}function l(){k(),h(),j()}function m(){t[t.length]={scale:a.data.map.scale,id:a.data.map.id}}function n(b){m(),p(),a.data.map.scale=b.scale,a.data.map.id=b.id,l()}function o(){p(),a.data.map=t.pop(),l()}function p(){a.data.map.sector=null,a.data.map.system=null,a.data.map.fleets=null}var q,r,s={id:"game",selector:"module-game",listeners:{"map-update":i,"map-click":g,"map-data-outdated":l}},t=[];return{properties:s,initialize:c,destroy:d}});